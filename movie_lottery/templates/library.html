<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∏–Ω–æ-–ª–æ—Ç–µ—Ä–µ—è: –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
</head>
<body class="gallery-body">
    <div class="background-rotator"></div>

    <header class="gallery-header">
        <h1>–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ —Ñ–∏–ª—å–º–æ–≤</h1>
        <div class="gallery-actions">
            <button id="my-polls-btn" class="nav-button" style="display: none;">
                –ú–æ–∏ –æ–ø—Ä–æ—Å—ã
                <span id="my-polls-badge" class="badge" style="display: none;"></span>
            </button>
            <div class="badge-poll-dropdown">
                <button id="badge-poll-btn" class="badge-poll-button">
                    üéØ –û–ø—Ä–æ—Å –ø–æ –±–µ–π–¥–∂—É
                    <span class="dropdown-arrow">‚ñº</span>
                </button>
                <div id="badge-poll-menu" class="badge-poll-menu">
                    <div class="badge-poll-menu-header">–í—ã–±–µ—Ä–∏—Ç–µ –±–µ–π–¥–∂ –¥–ª—è –æ–ø—Ä–æ—Å–∞:</div>
                    <div class="badge-poll-options">
                        <button class="badge-poll-option" data-badge="favorite" disabled>
                            <span class="badge-icon">‚≠ê</span>
                            <span class="badge-name">–õ—é–±–∏–º–æ–µ</span>
                            <span class="badge-count">(0)</span>
                        </button>
                        <button class="badge-poll-option" data-badge="watchlist" disabled>
                            <span class="badge-icon">üëÅÔ∏è</span>
                            <span class="badge-name">–•–æ—á—É –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å</span>
                            <span class="badge-count">(0)</span>
                        </button>
                        <button class="badge-poll-option" data-badge="top" disabled>
                            <span class="badge-icon">üèÜ</span>
                            <span class="badge-name">–¢–æ–ø</span>
                            <span class="badge-count">(0)</span>
                        </button>
                        <button class="badge-poll-option" data-badge="watched" disabled>
                            <span class="badge-icon">‚úÖ</span>
                            <span class="badge-name">–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ</span>
                            <span class="badge-count">(0)</span>
                        </button>
                        <button class="badge-poll-option" data-badge="new" disabled>
                            <span class="badge-icon">üî•</span>
                            <span class="badge-name">–ù–æ–≤–∏–Ω–∫–∞</span>
                            <span class="badge-count">(0)</span>
                        </button>
                    </div>
                </div>
            </div>
            <button id="toggle-select-mode-btn" class="nav-button">–í—ã–±—Ä–∞—Ç—å —Ñ–∏–ª—å–º—ã</button>
            <a href="{{ url_for('main.index') }}" class="nav-button">&larr; –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–æ–∑–¥–∞–Ω–∏—é</a>
            <a href="{{ url_for('main.history') }}" class="nav-button">–ò—Å—Ç–æ—Ä–∏—è</a>
        </div>
    </header>

    <div id="badge-filters-panel" class="badge-filters-panel">
        <div class="badge-filter-header">–§–∏–ª—å—Ç—Ä –ø–æ –±–µ–π–¥–∂–∞–º:</div>
        <div class="badge-filters">
            <button class="badge-filter active" data-badge="all">
                <span class="badge-filter-icon">üé¨</span>
                <span class="badge-filter-name">–í—Å–µ</span>
                <span class="badge-filter-count">(0)</span>
            </button>
            <button class="badge-filter" data-badge="favorite">
                <span class="badge-filter-icon">‚≠ê</span>
                <span class="badge-filter-name">–õ—é–±–∏–º–æ–µ</span>
                <span class="badge-filter-count">(0)</span>
            </button>
            <button class="badge-filter" data-badge="watchlist">
                <span class="badge-filter-icon">üëÅÔ∏è</span>
                <span class="badge-filter-name">–•–æ—á—É –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å</span>
                <span class="badge-filter-count">(0)</span>
            </button>
            <button class="badge-filter" data-badge="top">
                <span class="badge-filter-icon">üèÜ</span>
                <span class="badge-filter-name">–¢–æ–ø</span>
                <span class="badge-filter-count">(0)</span>
            </button>
            <button class="badge-filter" data-badge="watched">
                <span class="badge-filter-icon">‚úÖ</span>
                <span class="badge-filter-name">–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ</span>
                <span class="badge-filter-count">(0)</span>
            </button>
            <button class="badge-filter" data-badge="new">
                <span class="badge-filter-icon">üî•</span>
                <span class="badge-filter-name">–ù–æ–≤–∏–Ω–∫–∞</span>
                <span class="badge-filter-count">(0)</span>
            </button>
            <button class="badge-filter" data-badge="none">
                <span class="badge-filter-icon">‚ö™</span>
                <span class="badge-filter-name">–ë–µ–∑ –±–µ–π–¥–∂–∞</span>
                <span class="badge-filter-count">(0)</span>
            </button>
        </div>
    </div>
    
    <div id="selection-panel" class="selection-panel" style="display: none;">
        <div class="selection-info">
            <span id="selection-count">–í—ã–±—Ä–∞–Ω–æ: 0</span>
        </div>
        <div class="selection-actions">
            <button id="create-poll-from-selection-btn" class="cta-button" disabled>–°–æ–∑–¥–∞—Ç—å –æ–ø—Ä–æ—Å</button>
            <button id="cancel-selection-btn" class="secondary-button">–û—Ç–º–µ–Ω–∏—Ç—å</button>
        </div>
    </div>

    <svg class="icon-sprite" aria-hidden="true" focusable="false">
        <symbol id="icon-download" viewBox="0 0 24 24">
            <path d="M12 4v10" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="m7.5 10.5 4.5 4.5 4.5-4.5" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M5 18.5h14" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
        </symbol>
        <symbol id="icon-search" viewBox="0 0 24 24">
            <circle cx="11" cy="11" r="6.5" fill="none" stroke="currentColor" stroke-width="1.8"/>
            <path d="m16 16 4 4" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
        </symbol>
        <symbol id="icon-copy" viewBox="0 0 24 24">
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" transform="translate(-7 -7)"/>
            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
        </symbol>
        <symbol id="icon-delete" viewBox="0 0 24 24">
            <path d="M6 6 18 18" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M18 6 6 18" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
        </symbol>
    </svg>

    <div class="history-gallery library-gallery">
        {% if library_movies %}
            {% for movie in library_movies %}
                <div
                    class="gallery-item library-card {% if movie.is_on_client %}has-torrent-on-client{% endif %}"
                    data-movie-id="{{ movie.id }}"
                    data-kinopoisk-id="{{ movie.kinopoisk_id or '' }}"
                    data-movie-name="{{ movie.name|e }}"
                    data-movie-search-name="{{ (movie.search_name or '')|e }}"
                    data-movie-year="{{ movie.year or '' }}"
                    data-movie-poster="{{ (movie.poster or '')|e }}"
                    data-movie-description="{{ (movie.description|default('', true)|replace('\n', ' '))|e }}"
                    data-movie-rating="{{ '%.1f'|format(movie.rating_kp) if movie.rating_kp is not none else '' }}"
                    data-movie-genres="{{ (movie.genres|default('', true))|e }}"
                    data-movie-countries="{{ (movie.countries|default('', true))|e }}"
                    data-added-at="{{ movie.added_at.isoformat() }}"
                    data-has-magnet="{{ 'true' if movie.has_magnet else 'false' }}"
                    data-magnet-link="{{ (movie.magnet_link or '')|e }}"
                    data-is-on-client="{{ 'true' if movie.is_on_client else 'false' }}"
                    data-torrent-hash="{{ movie.torrent_hash|e if movie.torrent_hash else '' }}"
                    data-badge="{{ movie.badge or '' }}"
                >
                    <input type="checkbox" class="movie-checkbox" style="display: none;" data-movie-id="{{ movie.id }}">
                    <div class="torrent-status-indicator"></div>

                    {% if movie.badge %}
                    <div class="movie-badge" data-badge-type="{{ movie.badge }}">
                        {% if movie.badge == 'favorite' %}‚≠ê
                        {% elif movie.badge == 'watchlist' %}üëÅÔ∏è
                        {% elif movie.badge == 'top' %}üèÜ
                        {% elif movie.badge == 'watched' %}‚úÖ
                        {% elif movie.badge == 'new' %}üî•
                        {% endif %}
                    </div>
                    {% endif %}

                    <button type="button" class="badge-control-btn" title="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–µ–π–¥–∂–µ–º" aria-label="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–µ–π–¥–∂–µ–º">
                        üè∑Ô∏è
                    </button>

                    <div class="action-buttons">
                        {% if movie.has_magnet %}
                            <button
                                type="button"
                                class="icon-button copy-magnet-button"
                                title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å magnet-—Å—Å—ã–ª–∫—É"
                                aria-label="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å magnet-—Å—Å—ã–ª–∫—É"
                            >
                                <svg class="icon-svg icon-copy" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                                    <use href="#icon-copy"></use>
                                </svg>
                            </button>
                        {% else %}
                            <button
                                type="button"
                                class="icon-button search-rutracker-button"
                                title="–ù–∞–π—Ç–∏ –Ω–∞ RuTracker"
                                aria-label="–ù–∞–π—Ç–∏ –Ω–∞ RuTracker"
                            >
                                <svg class="icon-svg icon-search" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                                    <use href="#icon-search"></use>
                                </svg>
                            </button>
                        {% endif %}
                        <button
                            type="button"
                            class="icon-button delete-button"
                            title="–£–¥–∞–ª–∏—Ç—å –∏–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏"
                            aria-label="–£–¥–∞–ª–∏—Ç—å –∏–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏"
                        >
                            <svg class="icon-svg icon-delete" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                                <use href="#icon-delete"></use>
                            </svg>
                        </button>
                    </div>
                    <div class="date-badge" data-date="{{ movie.added_at.isoformat() }}"></div>
                    <img src="{{ movie.poster or 'https://via.placeholder.com/200x300.png?text=No+Image' }}" alt="{{ movie.name|e }}">
                </div>
            {% endfor %}
        {% endif %}
    </div>

    <p class="no-history library-empty-message"{% if library_movies %} style="display: none;"{% endif %}>–í –±–∏–±–ª–∏–æ—Ç–µ–∫–µ –ø–æ–∫–∞ –Ω–µ—Ç —Ñ–∏–ª—å–º–æ–≤.</p>

    <div id="library-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <div></div> </div>
    </div>

    <div id="badge-selector-modal" class="badge-selector-modal">
        <div class="badge-selector-content">
            <h3>–í—ã–±–µ—Ä–∏—Ç–µ –±–µ–π–¥–∂</h3>
            <div class="badge-options">
                <div class="badge-option" data-badge="favorite">
                    <span class="badge-icon">‚≠ê</span>
                    <span class="badge-label">–õ—é–±–∏–º–æ–µ</span>
                </div>
                <div class="badge-option" data-badge="watchlist">
                    <span class="badge-icon">üëÅÔ∏è</span>
                    <span class="badge-label">–•–æ—á—É –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å</span>
                </div>
                <div class="badge-option" data-badge="top">
                    <span class="badge-icon">üèÜ</span>
                    <span class="badge-label">–¢–æ–ø</span>
                </div>
                <div class="badge-option" data-badge="watched">
                    <span class="badge-icon">‚úÖ</span>
                    <span class="badge-label">–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ</span>
                </div>
                <div class="badge-option" data-badge="new">
                    <span class="badge-icon">üî•</span>
                    <span class="badge-label">–ù–æ–≤–∏–Ω–∫–∞</span>
                </div>
            </div>
            <div class="badge-selector-actions">
                <button class="remove-badge-btn">–£–±—Ä–∞—Ç—å –±–µ–π–¥–∂</button>
                <button class="cancel-badge-btn">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <script>
        window.appConfig = window.appConfig || {};
        window.appConfig.pollCreatorSecret = {{ poll_creator_secret|tojson }};
    </script>
    <script src="{{ url_for('static', filename='js/toast.js') }}"></script>
    <script type="module" src="{{ url_for('static', filename='js/pages/library.js') }}"></script>

    <script>
        var backgroundPhotos = {{ background_photos|tojson|safe }};
    </script>
    <script type="module" src="{{ url_for('static', filename='js/background.js') }}"></script>
</body>
</html>