# movie-lottery

Веб-приложение для случайного фильма или сериала

## Деплой

1. Перед выкатом обновления выполните миграцию Alembic `20240228_000001_add_search_name_columns`:
   ```bash
   alembic upgrade 20240228_000001
   ```
2. Убедитесь, что миграция применена на staging- и production-базах **до** повторного деплоя обновленного кода.
3. После применения миграции и перезапуска приложения откройте страницу `/library`, чтобы убедиться в отсутствии ошибки `ProgrammingError`.

### Переменные окружения

- `PUBLIC_BASE_URL` — публичный базовый адрес (например, `https://example.com` или `http://109.110.37.194:8888`),
  который используется для формирования абсолютных ссылок в API и интерфейсе (кнопки Telegram, копирование ссылок).
  Если переменная не задана, ссылки будут строиться от текущего домена приложения.
- `POLL_CUSTOM_VOTE_COST` — стоимость пользовательского голоса в баллах (по умолчанию `10`).

## API пользовательских голосов в опросах

- `GET /api/polls/<poll_id>` — возвращает данные опроса и баланс пользователя. В ответ добавлены поля:
  - `custom_vote_cost` — стоимость кастомного голосования;
  - `can_vote_custom` — можно ли сейчас использовать кастомный голос (учитывает баланс и наличие голоса в опросе).
- `POST /api/polls/<poll_id>/custom-vote` — добавить в опрос кастомный фильм и проголосовать за него.
  - Тело запроса: `{ "query": "название или ID", "kinopoisk_id": <опционально> }`.
  - Возможные ошибки: 400 (недостаточно баллов, некорректный JSON или пустой запрос, голос уже учтён),
    404 (фильм не найден), 410 (опрос завершён).
  - Успешный ответ содержит `success`, `movie` (данные фильма), `points_balance` и `has_voted`.
## Админская страница и API статистики голосов

- **Маршрут** `/admin/poll-points` — открытая страница с фильтрами, поиском по токенам, устройствам и списку опросов.
- **API**:
  - `GET /api/polls/voter-stats` — возвращает пагинированный список участников: `voter_token`, `device_label`,
    `total_points`, `filtered_points`, `votes_count`, `last_vote_at` и массив голосов (poll_id, название, дата, фильм,
    баллы, время голосования).
  - `GET /api/polls/voter-stats/<token>` — детализированная статистика конкретного токена с теми же полями.
- **Фильтры и пагинация**: доступны параметры `page`, `per_page`, `sort_by`, `sort_order`, а также фильтрация по poll id
  и диапазону дат (`date_from`, `date_to`). Период применяется к `Vote.voted_at`, поэтому можно быстро получить отчёт за
  конкретный опрос или неделю.

## Проверка Kinopoisk API

Для ручного тестирования интеграции с Kinopoisk API подготовлена CLI-утилита `movie_lottery.utils.kinopoisk`.

1. Установите переменную окружения с действующим токеном:
   ```bash
   export KINOPOISK_API_KEY="<ваш_токен>"
   ```
2. Выполните команду, чтобы запросить несколько фильмов (по ID, ссылке или названию):
   ```bash
   python -m movie_lottery.utils.kinopoisk 301 "https://www.kinopoisk.ru/film/435/" "Интерстеллар"
   ```

В ответе вы увидите JSON с основными данными фильма, что подтверждает успешное соединение с API. Если токен отсутствует или истек, утилита выведет сообщение об ошибке и завершится с ненулевым кодом.
